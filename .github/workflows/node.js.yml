name: Node.js CI

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [22.x]

    env:
      PORT: 8000
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      CORS_ORIGIN: "*"
      ACCESS_TOKEN_SECRET: ${{ secrets.ACCESS_TOKEN_SECRET }}
      ACCESS_TOKEN_EXPIRY: 2d
      REFRESH_TOKEN_SECRET: ${{ secrets.REFRESH_TOKEN_SECRET }}
      REFRESH_TOKEN_EXPIRY: 10d
      FCM_SERVER_KEY: ${{ secrets.FCM_SERVER_KEY }}
      CLOUDINARY_CLOUD_NAME: djzph8xdq
      CLOUDINARY_API_KEY: 528174949382811
      CLOUDINARY_API_SECRET: oSDhfKcUxsTaKGJzhpm_vx1izKU
      REDIS_HOST: redis-14824.c301.ap-south-1-1.ec2.redns.redis-cloud.com
      REDIS_PORT: 14824
      REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
      SMS_API_URL: https://api.your-sms-provider.com/send
      SMS_API_KEY: ${{ secrets.SMS_API_KEY }}
      WHATSAPP_API_URL: https://api.your-whatsapp-provider.com/send
      WHATSAPP_API_KEY: ${{ secrets.WHATSAPP_API_KEY }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies with npm ci
      run: npm ci

    - name: Verify MongoDB URI (for debugging)
      run: echo "MONGODB_URI is $MONGODB_URI"

    - name: Install PM2 globally
      run: npm install -g pm2

    - name: Restart Backend with PM2
      run: pm2 restart Backend
